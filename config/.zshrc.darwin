#!/bin/zsh
# Homebrew
export PATH="/opt/homebrew/bin:$PATH"
# eval "$(/opt/homebrew/bin/brew shellenv)"
export HOMEBREW_CASK_OPTS="--appdir=/Applications"

export PATH="/usr/local/sbin:/usr/local/opt/libarchive/bin:$PATH"
alias nproc="sysctl -n hw.logicalcpu"
alias clion="open -na 'CLion.app'"

# Ruby
export PATH="/opt/homebrew/opt/ruby/bin:$PATH"
# You must edit the version if ruby's latest changes in brew
export PATH="/opt/homebrew/lib/ruby/gems/3.2.0/bin:$PATH"

# export OPENBLAS=$(/opt/homebrew/bin/brew --prefix openblas)
export CFLAGS="-falign-functions=8 ${CFLAGS}"

# LIMA
#export DOCKER_HOST=unix://${HOME}/.lima/docker/sock/docker.sock
export DOCKER_HOST=unix:///var/run/docker.sock
export LIMA_INSTANCE=docker

# GNU sed
alias sed=gsed

# Kubectl
export USE_GKE_GCLOUD_AUTH_PLUGIN=True

# hdf5
#export HDF5_DIR=$(/opt/homebrew/bin/brew --prefix hdf5)

# Google Cloud SDK Python setting
export CLOUDSDK_PYTHON=$HOME/.local/share/mise/installs/python/3.12/bin/python

# PulseAudioã‚’èµ·å‹•ã—ã€èªè¨¼ã‚¯ãƒƒã‚­ãƒ¼ã‚’è‡ªå‹•åŒæœŸã—ã¦SSHæ¥ç¶šã™ã‚‹é–¢æ•°
function ssh-sound() {
  # æ¥ç¶šå…ˆãƒ›ã‚¹ãƒˆåãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
  if [ -z "$1" ]; then
    echo "Usage: ssh-sound <hostname>"
    return 1
  fi

  local host="$1" # æœ€åˆã®å¼•æ•°ã‚’ãƒ›ã‚¹ãƒˆåã¨ã—ã¦ä¿å­˜

  # 1. PulseAudioã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ãƒã‚§ãƒƒã‚¯
  if ! pgrep -x "pulseaudio" > /dev/null; then
    echo "ğŸš€ Starting PulseAudio with authentication enabled..."
    pulseaudio --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-cookie=$HOME/.config/pulse/cookie" --exit-idle-time=-1 --daemon
    sleep 1 # ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºã‚’å¾…ã¤
  else
    echo "ğŸ§ PulseAudio is already running."
    # æ—¢ã«èµ·å‹•ã—ã¦ã„ã‚‹å ´åˆã€TCPãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    if ! pactl list modules short | grep -q "module-native-protocol-tcp"; then
      echo "ğŸ”§ Loading TCP module with authentication..."
      pactl load-module module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-cookie=$HOME/.config/pulse/cookie
    fi
  fi

  # macOSã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹ã«åˆã‚ã›ã¦PulseAudioã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ãƒ³ã‚¯ã‚’è¨­å®š
  # system_profilerã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹åã‚’å–å¾—
  local macos_default=$(system_profiler SPAudioDataType 2>/dev/null | awk '/Default Output Device: Yes/{found=1} found && /Manufacturer:/{print prev; exit} {prev=$0}' | sed 's/^[[:space:]]*//' | sed 's/:$//')

  if [ -n "$macos_default" ]; then
    # PulseAudioã®ã‚·ãƒ³ã‚¯ä¸€è¦§ã‹ã‚‰å¯¾å¿œã™ã‚‹ã‚·ãƒ³ã‚¯ã‚’æ¤œç´¢
    local pa_sink=$(pactl list sinks | grep -B 1 "$macos_default" | grep "Name:" | awk '{print $2}' | head -1)

    if [ -n "$pa_sink" ]; then
      echo "ğŸ”Š Setting default sink to: $macos_default"
      pactl set-default-sink "$pa_sink" 2>/dev/null || echo "âš ï¸ Failed to set default sink"
    fi
  fi

  # 2. èªè¨¼ã‚¯ãƒƒã‚­ãƒ¼ã®è‡ªå‹•åŒæœŸ
  echo "ğŸ”‘ Checking authentication cookie for $host..."

  # Macä¸Šã®ã‚¯ãƒƒã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
  local local_cookie_file="$HOME/.config/pulse/cookie"
  # ãƒªãƒ¢ãƒ¼ãƒˆ(Linux)ä¸Šã®ã‚¯ãƒƒã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
  local remote_cookie_file="~/.config/pulse/cookie"

  # Macã«ã‚¯ãƒƒã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
  if [ ! -f "$local_cookie_file" ]; then
      echo "âš ï¸ Local PulseAudio cookie not found. Please run a sound application once."
      return 1
  fi

  # Macã®ã‚¯ãƒƒã‚­ãƒ¼ã®ãƒãƒƒã‚·ãƒ¥å€¤ã¨ã€Linuxã®ã‚¯ãƒƒã‚­ãƒ¼ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’å–å¾—
  local local_hash=$(shasum "$local_cookie_file" | awk '{print $1}')
  local remote_hash=$(ssh "$host" "shasum $remote_cookie_file 2>/dev/null | awk '{print \$1}'")

  # ãƒãƒƒã‚·ãƒ¥å€¤ã‚’æ¯”è¼ƒã—ã€ç•°ãªã£ã¦ã„ã‚Œã°scpã§ã‚³ãƒ”ãƒ¼
  if [ "$local_hash" != "$remote_hash" ]; then
    echo "ğŸ”„ Cookie is outdated. Syncing..."
    # ãƒªãƒ¢ãƒ¼ãƒˆå´ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
    ssh "$host" "mkdir -p ~/.config/pulse"
    scp -q "$local_cookie_file" "${host}:${remote_cookie_file}"
    if [ $? -eq 0 ]; then
      echo "âœ… Cookie successfully synced."
    else
      echo "âŒ Failed to sync cookie."
      return 1
    fi
  else
    echo "ğŸ‘ Cookie is already up-to-date."
  fi

  # 3. SSHæ¥ç¶šã®å®Ÿè¡Œ
  echo "ğŸ“¡ Connecting to $host with audio forwarding..."
  ssh "$@"
}
